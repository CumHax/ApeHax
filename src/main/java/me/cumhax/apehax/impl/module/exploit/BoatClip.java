package me.cumhax.apehax.impl.module.exploit;

import java.lang.reflect.Field;

import me.cumhax.apehax.api.module.Category;
import me.cumhax.apehax.api.module.Module;
import me.cumhax.apehax.api.setting.Setting;
import me.cumhax.apehax.api.setting.SettingType;
import me.cumhax.apehax.api.util.CommandUtil;
import net.minecraft.entity.item.EntityBoat;
import net.minecraft.network.play.client.CPacketPlayer;
import net.minecraft.network.play.client.CPacketVehicleMove;
import net.minecraftforge.fml.relauncher.ReflectionHelper;

public class BoatClip extends Module {

	int timer = 0;
	boolean z = false;

	private final Setting BoatSpeed = new Setting.Builder(SettingType.INTEGER).setName("BoatSpeed").setModule(this)
			.setIntegerValue(2).setMinIntegerValue(1).setMaxIntegerValue(5).build();

	protected static final Field vehiclemovey = ReflectionHelper.findField(CPacketVehicleMove.class, "y",
			"field_187008_b", "b");

	// cpacketVehicleMoveY = getField(CPacketVehicleMove.class, "y",
	// "field_187008_b");
	public BoatClip(String name, String description, Category category) {
		super(name, description, category);
		addSetting(BoatSpeed);
	}

	public void onUpdate() {
		if (mc.player == null) {
			return;
		}
		if ((mc.player.getRidingEntity() instanceof EntityBoat)) {
			EntityBoat riding = (EntityBoat) mc.player.getRidingEntity();
			CPacketVehicleMove packetVehicleMove = new CPacketVehicleMove(riding);

			int xTo = 2;
			int yTo = 56;
			int zTo = 143;

			if (mc.gameSettings.keyBindBack.isKeyDown()) {
				try {
					vehiclemovey.setInt(packetVehicleMove, -2);
				} catch (Exception e) {
					e.printStackTrace();
					CommandUtil.sendChatMessage("error");
				}
				// setPrivateValue(CPacketVehicleMove.class, packetVehicleMove,
				// Integer.valueOf(-2), new String[] { "y" });

				if (mc.player.posY > 0.0D) {
					mc.player.motionX -= getMotionX(mc.player.rotationYaw);
					mc.player.motionZ -= getMotionZ(mc.player.rotationYaw);
				}
			}

			mc.getConnection()
					.sendPacket(new CPacketPlayer.PositionRotation(mc.player.posX + mc.player.motionX,
							mc.player.posY + (z ? 0.0625D : mc.gameSettings.keyBindJump.isKeyDown() ? 0.0624D : 1.0E-8D)
									- (z ? 0.0625D : mc.gameSettings.keyBindSneak.isKeyDown() ? 0.0624D : 2.0E-8D),
							mc.player.posZ + mc.player.motionZ, mc.player.rotationYaw, mc.player.rotationPitch, false));

			z = (!z);
			mc.getConnection().sendPacket(packetVehicleMove);
		}

		if (mc.player.posY < 0.0D) {
			timer += 1;
		} else {
			timer = 0;
		}
		if (timer == 20) {
			CommandUtil.sendRawChatMessage("trying to clip");
		}

		if ((timer > 20) && (mc.player.posY < 0.0D)) {
			timer = 21;
			if (mc.player.isRiding()) {
				mc.player.dismountRidingEntity();
			}
			double oldMotionX = mc.player.motionX;
			double oldMotionY = mc.player.motionY;
			double oldMotionZ = mc.player.motionZ;

			double[] dir = moveLooking();

			if (((mc.gameSettings.keyBindForward.isKeyDown()) || (mc.gameSettings.keyBindLeft.isKeyDown())
					|| (mc.gameSettings.keyBindRight.isKeyDown()) || (mc.gameSettings.keyBindBack.isKeyDown()))
					&& (!mc.gameSettings.keyBindJump.isKeyDown())) {
				mc.player.motionX = (getMotionX(mc.player.cameraYaw) * 0.26D);
				mc.player.motionZ = (getMotionZ(mc.player.cameraYaw) * 0.26D);
			}

			mc.getConnection()
					.sendPacket(new CPacketPlayer.PositionRotation(mc.player.posX + mc.player.motionX,
							mc.player.posY + (z ? 0.0625D : mc.gameSettings.keyBindJump.isKeyDown() ? 0.0624D : 1.0E-8D)
									- (z ? 0.0625D : mc.gameSettings.keyBindSneak.isKeyDown() ? 0.0624D : 2.0E-8D),
							mc.player.posZ + mc.player.motionZ, mc.player.rotationYaw, mc.player.rotationPitch, false));
			mc.getConnection()
					.sendPacket(new CPacketPlayer.PositionRotation(mc.player.posX + mc.player.motionX,
							1337.0D + mc.player.posY, mc.player.posZ + mc.player.motionZ, mc.player.rotationYaw,
							mc.player.rotationPitch, true));
			mc.getConnection().sendPacket(new net.minecraft.network.play.client.CPacketEntityAction(mc.player,
					net.minecraft.network.play.client.CPacketEntityAction.Action.START_FALL_FLYING));
			// mc.player.setFlag(7, false);

			mc.player.motionX = oldMotionX;
			mc.player.motionY = oldMotionY;
			mc.player.motionZ = oldMotionZ;
		}

	}

	public double[] moveLooking() {
		return new double[] { mc.player.rotationYaw * 360.0F / 360.0F * 180.0F / 180.0F, 0.0D };
	}

	private double getMotionX(float yaw) {
		return net.minecraft.util.math.MathHelper.sin(-yaw * 0.017453292F * 1.0F) * (BoatSpeed.getIntegerValue());
	}

	private double getMotionZ(float yaw) {
		return net.minecraft.util.math.MathHelper.cos(yaw * 0.017453292F) * 1.0F * (BoatSpeed.getIntegerValue());
	}

}
