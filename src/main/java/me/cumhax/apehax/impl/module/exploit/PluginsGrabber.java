package me.cumhax.apehax.impl.module.exploit;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

import me.cumhax.apehax.api.module.Category;
import me.cumhax.apehax.api.module.Module;
import me.cumhax.apehax.api.util.CommandUtil;
import me.cumhax.apehax.impl.event.PacketReceiveEvent;
import joptsimple.internal.Strings;
import net.minecraft.network.play.client.CPacketTabComplete;
import net.minecraft.network.play.server.SPacketTabComplete;
import net.minecraftforge.fml.common.eventhandler.SubscribeEvent;

public class PluginsGrabber extends Module {

	public PluginsGrabber(String name, String description, Category category) {
		super(name, description, category);
	}

	@Override
	public void onEnable()
	{
		super.onEnable();
		CommandUtil.sendChatMessage("Obtaining plugins");
		CPacketTabComplete packet = new CPacketTabComplete("/", null, false);
		mc.player.connection.sendPacket(packet);
	}

	@SubscribeEvent
	public void onReceivePacket(PacketReceiveEvent event) {
		if (event.getPacket() instanceof SPacketTabComplete) {
			SPacketTabComplete s3APacketTabComplete = (SPacketTabComplete) event.getPacket();

			List<String> plugins = new ArrayList<String>();
			String[] commands = s3APacketTabComplete.getMatches();

			for (int i = 0; i < commands.length; i++) {
				String[] command = commands[i].split(":");

				if (command.length > 1) {
					String pluginName = command[0].replace("/", "");

					if (!plugins.contains(pluginName)) {
						plugins.add(pluginName);
					}
				}
			}

			Collections.sort(plugins);

			if (!plugins.isEmpty()) {
				CommandUtil.sendChatMessage("Plugins \u00a77(\u00a78" + plugins.size() + "\u00a77): \u00a79"
						+ Strings.join(plugins.toArray(new String[0]), "\u00a77, \u00a79"));
			} else {
				CommandUtil.sendChatMessage("No plugins found");
			}

			this.disable();
		}
	}

}
